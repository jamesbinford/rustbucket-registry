<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RustBucket Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .nav-links {
            margin-bottom: 20px;
        }
        .nav-links a {
            color: #2196F3;
            text-decoration: none;
            margin-right: 15px;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .filter-controls {
            background-color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .filter-controls label {
            font-weight: bold;
            color: #333;
        }
        .filter-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .custom-range {
            display: none;
            align-items: center;
            gap: 10px;
        }
        .custom-range input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .custom-range button {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .custom-range button:hover {
            background-color: #1976D2;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding-left: 20px;
            border-left: 1px solid #ddd;
        }
        .auto-refresh label {
            font-weight: normal;
            font-size: 14px;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        .refresh-indicator {
            font-size: 12px;
            color: #666;
        }
        .refresh-indicator.active {
            color: #4CAF50;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .refreshing {
            animation: pulse 1s ease-in-out;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }
        .stat-card.active .value {
            color: #2e7d32;
        }
        .stat-card.attacks .value {
            color: #c62828;
        }
        .stat-card.alerts .value {
            color: #ef6c00;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .chart-container h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        .chart-container canvas {
            max-height: 300px;
        }
        .chart-container.full-width {
            grid-column: span 2;
        }
        .resources-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .resources-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .resource-card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .resource-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        .resource-card .status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 3px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .resource-card .status.active {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .resource-card .status.inactive {
            background-color: #ffebee;
            color: #c62828;
        }
        .resource-card .status.maintenance {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .metric-row label {
            font-size: 12px;
            color: #666;
        }
        .metric-row .value {
            font-weight: bold;
            font-size: 14px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-bar .fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .progress-bar .fill.low {
            background-color: #2e7d32;
        }
        .progress-bar .fill.medium {
            background-color: #ef6c00;
        }
        .progress-bar .fill.high {
            background-color: #c62828;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-container.full-width {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RustBucket Dashboard</h1>
        <div class="nav-links">
            <a href="{% url 'home' %}">Home</a>
            <a href="{% url 'logsinks' %}">LogSinks</a>
            <a href="{% url 'registration_keys' %}">Registration Keys</a>
        </div>

        <div class="filter-controls">
            <label for="time-range">Time Range:</label>
            <select id="time-range" onchange="handleTimeRangeChange()">
                <option value="24h">Last 24 Hours</option>
                <option value="7d" selected>Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="custom">Custom Range</option>
            </select>
            <div id="custom-range" class="custom-range">
                <input type="datetime-local" id="start-date">
                <span>to</span>
                <input type="datetime-local" id="end-date">
                <button onclick="applyCustomRange()">Apply</button>
            </div>
            <div class="auto-refresh">
                <label for="auto-refresh-toggle">Auto-refresh</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
                    <span class="toggle-slider"></span>
                </div>
                <select id="refresh-interval" onchange="updateRefreshInterval()">
                    <option value="30">30s</option>
                    <option value="60" selected>1m</option>
                    <option value="300">5m</option>
                </select>
                <span id="refresh-indicator" class="refresh-indicator"></span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Rustbuckets</h3>
                <div class="value" id="total-buckets">-</div>
            </div>
            <div class="stat-card active">
                <h3>Active Rustbuckets</h3>
                <div class="value" id="active-buckets">-</div>
            </div>
            <div class="stat-card attacks">
                <h3>Total Attacks</h3>
                <div class="value" id="total-attacks">-</div>
            </div>
            <div class="stat-card alerts">
                <h3>Unresolved Alerts</h3>
                <div class="value" id="unresolved-alerts">-</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container full-width">
                <h3>Attack Trends Over Time</h3>
                <canvas id="attackTrendsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top Attacking IPs</h3>
                <canvas id="topIPsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Attacks by Country</h3>
                <canvas id="countriesChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Alert Distribution</h3>
                <canvas id="alertsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Most Targeted Rustbuckets</h3>
                <canvas id="targetsChart"></canvas>
            </div>
        </div>

        <div class="resources-section">
            <h3>Current Resource Usage</h3>
            <div id="resources-grid" class="resources-grid">
                <div class="loading">Loading resource data...</div>
            </div>
        </div>
    </div>

    <script>
        // Chart instances
        let charts = {
            attackTrends: null,
            topIPs: null,
            countries: null,
            alerts: null,
            targets: null
        };

        // Current time range
        let currentRange = '7d';

        // Auto-refresh state
        let autoRefreshInterval = null;
        let refreshIntervalSeconds = 60;
        let countdownInterval = null;
        let secondsUntilRefresh = 0;

        function toggleAutoRefresh() {
            const toggle = document.getElementById('auto-refresh-toggle');
            const indicator = document.getElementById('refresh-indicator');

            if (toggle.checked) {
                startAutoRefresh();
                indicator.classList.add('active');
            } else {
                stopAutoRefresh();
                indicator.classList.remove('active');
                indicator.textContent = '';
            }
        }

        function updateRefreshInterval() {
            refreshIntervalSeconds = parseInt(document.getElementById('refresh-interval').value);
            const toggle = document.getElementById('auto-refresh-toggle');
            if (toggle.checked) {
                stopAutoRefresh();
                startAutoRefresh();
            }
        }

        function startAutoRefresh() {
            secondsUntilRefresh = refreshIntervalSeconds;
            updateCountdown();

            countdownInterval = setInterval(() => {
                secondsUntilRefresh--;
                updateCountdown();
            }, 1000);

            autoRefreshInterval = setInterval(() => {
                refreshDashboard();
                secondsUntilRefresh = refreshIntervalSeconds;
            }, refreshIntervalSeconds * 1000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function updateCountdown() {
            const indicator = document.getElementById('refresh-indicator');
            if (secondsUntilRefresh > 60) {
                const mins = Math.floor(secondsUntilRefresh / 60);
                const secs = secondsUntilRefresh % 60;
                indicator.textContent = `${mins}m ${secs}s`;
            } else {
                indicator.textContent = `${secondsUntilRefresh}s`;
            }
        }

        function refreshDashboard() {
            const container = document.querySelector('.container');
            container.classList.add('refreshing');
            loadDashboardData().then(() => {
                setTimeout(() => container.classList.remove('refreshing'), 500);
            });
        }

        function handleTimeRangeChange() {
            const select = document.getElementById('time-range');
            const customRange = document.getElementById('custom-range');

            if (select.value === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
                currentRange = select.value;
                loadDashboardData();
            }
        }

        function applyCustomRange() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            currentRange = 'custom';
            loadDashboardData(startDate, endDate);
        }

        function getQueryParams(startDate, endDate) {
            if (currentRange === 'custom' && startDate && endDate) {
                return `range=custom&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}`;
            }
            return `range=${currentRange}`;
        }

        async function loadDashboardData(startDate, endDate) {
            const params = getQueryParams(startDate, endDate);

            // Load all data in parallel
            try {
                const [overview, attacks, topIps, countries, alerts, targets, resources] = await Promise.all([
                    fetch(`/api/dashboard/overview/?${params}`).then(r => r.json()),
                    fetch(`/api/dashboard/attacks/?${params}`).then(r => r.json()),
                    fetch(`/api/dashboard/top-ips/?${params}`).then(r => r.json()),
                    fetch(`/api/dashboard/countries/?${params}`).then(r => r.json()),
                    fetch(`/api/dashboard/alerts/?${params}`).then(r => r.json()),
                    fetch(`/api/dashboard/targets/?${params}`).then(r => r.json()),
                    fetch('/api/dashboard/resources/').then(r => r.json())
                ]);

                updateOverviewCards(overview);
                updateAttackTrendsChart(attacks);
                updateTopIPsChart(topIps);
                updateCountriesChart(countries);
                updateAlertsChart(alerts);
                updateTargetsChart(targets);
                updateResourcesGrid(resources);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateOverviewCards(data) {
            document.getElementById('total-buckets').textContent = data.total_rustbuckets || 0;
            document.getElementById('active-buckets').textContent = data.active_rustbuckets || 0;
            document.getElementById('total-attacks').textContent = data.total_attacks || 0;
            document.getElementById('unresolved-alerts').textContent = data.unresolved_alerts || 0;
        }

        function updateAttackTrendsChart(data) {
            const ctx = document.getElementById('attackTrendsChart').getContext('2d');

            if (charts.attackTrends) {
                charts.attackTrends.destroy();
            }

            charts.attackTrends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels || [],
                    datasets: (data.datasets || []).map(ds => ({
                        label: ds.label,
                        data: ds.data,
                        borderColor: ds.borderColor,
                        backgroundColor: ds.borderColor + '20',
                        fill: true,
                        tension: 0.3
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopIPsChart(data) {
            const ctx = document.getElementById('topIPsChart').getContext('2d');

            if (charts.topIPs) {
                charts.topIPs.destroy();
            }

            charts.topIPs = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Attacks',
                        data: data.data || [],
                        backgroundColor: '#2196F3'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateCountriesChart(data) {
            const ctx = document.getElementById('countriesChart').getContext('2d');

            if (charts.countries) {
                charts.countries.destroy();
            }

            charts.countries = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Attacks',
                        data: data.data || [],
                        backgroundColor: '#9c27b0'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateAlertsChart(data) {
            const ctx = document.getElementById('alertsChart').getContext('2d');

            if (charts.alerts) {
                charts.alerts.destroy();
            }

            charts.alerts = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        data: data.data || [],
                        backgroundColor: data.colors || ['#c62828', '#ef6c00', '#1565c0', '#2e7d32']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updateTargetsChart(data) {
            const ctx = document.getElementById('targetsChart').getContext('2d');

            if (charts.targets) {
                charts.targets.destroy();
            }

            charts.targets = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Attacks',
                        data: data.data || [],
                        backgroundColor: '#c62828'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function getProgressClass(value) {
            if (value < 50) return 'low';
            if (value < 80) return 'medium';
            return 'high';
        }

        function updateResourcesGrid(data) {
            const grid = document.getElementById('resources-grid');
            const rustbuckets = data.rustbuckets || [];

            if (rustbuckets.length === 0) {
                grid.innerHTML = '<div class="loading">No active rustbuckets found</div>';
                return;
            }

            grid.innerHTML = rustbuckets.map(bucket => `
                <div class="resource-card">
                    <h4>${bucket.name}</h4>
                    <span class="status ${bucket.status.toLowerCase()}">${bucket.status}</span>

                    <div class="metric-row">
                        <label>CPU Usage</label>
                        <span class="value">${bucket.cpu_usage}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="fill ${getProgressClass(bucket.cpu_usage)}" style="width: ${bucket.cpu_usage}%"></div>
                    </div>

                    <div class="metric-row">
                        <label>Memory Usage</label>
                        <span class="value">${bucket.memory_usage}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="fill ${getProgressClass(bucket.memory_usage)}" style="width: ${bucket.memory_usage}%"></div>
                    </div>

                    <div class="metric-row">
                        <label>Disk Usage</label>
                        <span class="value">${bucket.disk_usage}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="fill ${getProgressClass(bucket.disk_usage)}" style="width: ${bucket.disk_usage}%"></div>
                    </div>

                    <div class="metric-row">
                        <label>Connections</label>
                        <span class="value">${bucket.connections}</span>
                    </div>
                </div>
            `).join('');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
    </script>
</body>
</html>
